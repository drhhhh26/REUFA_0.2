<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="mobile-web-app-capable" content="yes">

    <!-- Security Headers -->
    <meta http-equiv="X-Frame-Options" content="DENY">
    <meta http-equiv="X-Content-Type-Options" content="nosniff">
    <meta http-equiv="Referrer-Policy" content="strict-origin-when-cross-origin">
    <meta http-equiv="Permissions-Policy" content="geolocation=(), microphone=(), camera=()">
    <meta http-equiv="Content-Security-Policy" content="default-src 'self'; script-src 'self' 'unsafe-inline' https://script.google.com https://script.googleusercontent.com; style-src 'self' 'unsafe-inline' https://fonts.googleapis.com https://cdnjs.cloudflare.com; font-src 'self' https://fonts.gstatic.com https://cdnjs.cloudflare.com; img-src 'self' data: https:; connect-src 'self' https://*.google.com https://*.googleusercontent.com https://script.google.com https://script.googleusercontent.com; frame-src https://drive.google.com;">

    <title>×œ×§×—×™× ×××™×¨×•×¢×™× - ××“×•×¨ ×¨×¤×•××”</title>

    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Rubik:wght@400;500;600;700;800&display=swap" rel="stylesheet" crossorigin="anonymous">

    <!-- FontAwesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" crossorigin="anonymous" referrerpolicy="no-referrer">

    <!-- Shared Styles -->
    <link rel="stylesheet" href="styles.css">

    <style>
        /* ×¡×˜×™×™×œ×™× ×™×™×—×•×“×™×™× ×œ×¢××•×“ ×œ×§×—×™× ×××™×¨×•×¢×™× - ×¨×©×ª ×›×¨×˜×™×¡×™× */
        body {
            background: linear-gradient(rgba(0, 0, 0, 0.3), rgba(0, 0, 0, 0.3)), url('Assets/background.JPEG');
            background-size: cover;
            background-position: center;
            background-repeat: no-repeat;
            background-attachment: fixed;
        }

        .documents-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
            gap: 14px;
            padding-bottom: 20px;
        }

        .document-card {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 16px;
            padding: 20px 16px;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            box-shadow: 0 6px 24px rgba(0, 0, 0, 0.15);
            border: 1px solid rgba(255, 255, 255, 0.3);
            position: relative;
            overflow: hidden;
            display: flex;
            flex-direction: column;
            align-items: center;
            text-align: center;
            animation: fadeInUp 0.5s ease-out backwards;
            min-height: 160px;
        }

        .document-card::before {
            content: '';
            position: absolute;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: radial-gradient(circle, rgba(239, 68, 68, 0.12) 0%, transparent 70%);
            opacity: 0;
            transition: all 0.4s ease;
            transform: scale(0);
        }

        .document-card:active {
            transform: scale(0.97);
            box-shadow: 0 2px 10px rgba(220, 38, 38, 0.12);
        }

        .document-card:active::before {
            opacity: 1;
            transform: scale(1);
        }

        .document-emoji {
            font-size: 3rem;
            margin-bottom: 12px;
            display: block;
            transition: all 0.3s ease;
            filter: drop-shadow(0 2px 4px rgba(0, 0, 0, 0.1));
        }

        .document-card:active .document-emoji {
            transform: scale(1.1);
        }

        .document-title {
            font-size: 0.9rem;
            font-weight: 600;
            color: #7f1d1d;
            line-height: 1.3;
            word-break: break-word;
            hyphens: auto;
            flex: 1;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .pdf-badge {
            position: absolute;
            top: 8px;
            left: 8px;
            background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
            color: white;
            padding: 4px 8px;
            border-radius: 6px;
            font-size: 0.65rem;
            font-weight: 700;
            box-shadow: 0 2px 6px rgba(239, 68, 68, 0.3);
            letter-spacing: 0.5px;
        }

        /* ××¡×š ×˜×¢×™× ×” */
        .loading-screen {
            text-align: center;
            padding: 60px 20px;
        }

        .loading-spinner {
            width: 40px;
            height: 40px;
            border: 3px solid rgba(239, 68, 68, 0.2);
            border-top: 3px solid #ef4444;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 16px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .loading-text {
            font-size: 1rem;
            font-weight: 600;
            color: #7f1d1d;
        }

        .error-message {
            background: rgba(239, 68, 68, 0.1);
            border: 2px solid #ef4444;
            border-radius: 12px;
            padding: 20px;
            margin: 20px 0;
            color: #991b1b;
            text-align: center;
            font-weight: 600;
        }

        /* Responsive */
        @media (min-width: 400px) {
            .documents-grid {
                grid-template-columns: repeat(auto-fill, minmax(160px, 1fr));
                gap: 16px;
            }

            .document-card {
                padding: 24px 18px;
                min-height: 180px;
            }

            .document-emoji {
                font-size: 3.5rem;
            }

            .document-title {
                font-size: 0.95rem;
            }
        }

        @media (min-width: 600px) {
            .documents-grid {
                grid-template-columns: repeat(auto-fill, minmax(180px, 1fr));
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <div class="header-buttons">
                <button class="back-btn" onclick="goBack()">
                    <i class="fas fa-arrow-right"></i>
                </button>
                <button class="home-btn" onclick="goHome()">
                    ğŸ 
                </button>
            </div>
            <h1 class="page-title">×œ×§×—×™× ×××™×¨×•×¢×™×</h1>
            <div class="header-logos">
                <img src="Assets/logo1.PNG" alt="Logo 1">
                <img src="Assets/logo2.PNG" alt="Logo 2">
            </div>
        </div>

        <!-- ××¡×š ×˜×¢×™× ×” -->
        <div id="loading-screen" class="loading-screen">
            <div class="loading-spinner"></div>
            <div class="loading-text">×˜×•×¢×Ÿ ××¡××›×™×...</div>
        </div>

        <!-- ×”×•×“×¢×ª ×©×’×™××” -->
        <div id="error-screen" style="display: none;">
            <div class="error-message">
                <div style="font-size: 2rem; margin-bottom: 10px;">âš ï¸</div>
                <div id="error-text">×©×’×™××” ×‘×˜×¢×™× ×ª ×”××¡××›×™×</div>
            </div>
        </div>

        <!-- ×¨×©×ª ××¡××›×™× -->
        <div id="documents-grid" class="documents-grid" style="display: none;"></div>
    </div>

    <script>
        // ×›×ª×•×‘×ª ×”-Apps Script ×©×™×—×–×™×¨ ××ª ×¨×©×™××ª ×”××¡××›×™×
        const DOCUMENTS_URL = 'https://script.google.com/macros/s/AKfycbxeoeAGrR2LS1Mi4n1DUDAW8pBMehzcwtLn1A3qVTnY4a10-j09e9C-tSXrPehv1o6P/exec';

        let documents = [];
        let lastLoadTime = 0;
        const RATE_LIMIT_MS = 2000; // ××™× ×™××•× 2 ×©× ×™×•×ª ×‘×™×Ÿ ×˜×¢×™× ×•×ª

        // ×‘×“×™×§×ª URL ×ª×§×™×Ÿ ×•×‘×˜×•×—
        function isValidUrl(url) {
            if (!url || typeof url !== 'string') return false;

            try {
                const urlObj = new URL(url);
                // ×¨×§ HTTPS ×•×××§×•×¨×•×ª ××”×™×× ×™×
                return urlObj.protocol === 'https:' &&
                       (urlObj.hostname === 'drive.google.com' ||
                        urlObj.hostname === 'script.google.com' ||
                        urlObj.hostname === 'script.googleusercontent.com');
            } catch (e) {
                return false;
            }
        }

        // ×˜×¢×™× ×ª ××¡××›×™× ×-Google Sheets
        async function loadDocuments() {
            // Rate limiting
            const now = Date.now();
            if (now - lastLoadTime < RATE_LIMIT_MS) {
                console.warn('â±ï¸ ×”××ª×Ÿ ×œ×¤× ×™ ×˜×¢×™× ×” ××—×“×©');
                return;
            }
            lastLoadTime = now;

            console.log('ğŸ”„ ××ª×—×™×œ ×˜×¢×™× ×ª ××¡××›×™×...');
            console.log('ğŸ“ URL:', DOCUMENTS_URL);

            try {
                console.log('ğŸ“¡ ×©×•×œ×— ×‘×§×©×” ×œ-Google Apps Script...');
                const response = await fetch(DOCUMENTS_URL);

                console.log('ğŸ“Š ×ª×’×•×‘×” ×”×ª×§×‘×œ×”. Status:', response.status);

                if (!response.ok) {
                    throw new Error(`×©×’×™××ª ×©×¨×ª: ${response.status}`);
                }

                const data = await response.json();
                console.log('ğŸ“¦ × ×ª×•× ×™×:', data);

                if (!data.success) {
                    console.error('âŒ data.success = false');
                    throw new Error(data.error || '×©×’×™××” ×‘×˜×¢×™× ×ª × ×ª×•× ×™×');
                }

                console.log(`ğŸ“‹ ${data.documents?.length || 0} ××¡××›×™× × ××¦××•`);

                // ×¡×™× ×•×Ÿ ×•×•×œ×™×“×¦×™×” ×©×œ ×”××¡××›×™×
                documents = (data.documents || [])
                    .filter(d => {
                        const valid = d.title && d.title.trim() !== '' && d.url;
                        if (!valid) console.warn('âš ï¸ ××¡××š ×œ× ×ª×§×™×Ÿ:', d);
                        return valid;
                    })
                    .filter(d => {
                        const valid = isValidUrl(d.url);
                        if (!valid) console.warn('âš ï¸ URL ×œ× ×ª×§×™×Ÿ:', d.url);
                        return valid;
                    })
                    .map(d => ({
                        title: String(d.title).substring(0, 150),
                        emoji: String(d.emoji || 'ğŸš¨').substring(0, 10),
                        url: d.url
                    }));

                console.log(`âœ… ${documents.length} ××¡××›×™× ×ª×§×™× ×™×`);

                if (documents.length === 0) {
                    throw new Error('×œ× × ××¦××• ××¡××›×™× ×ª×§×™× ×™×');
                }

                displayDocuments();

            } catch (error) {
                console.error('âŒ ×©×’×™××” ×‘×˜×¢×™× ×ª ××¡××›×™×:', error);
                console.error('ğŸ“‹ ×¤×¨×˜×™ ×©×’×™××”:', error.message, error.stack);
                showError('×œ× × ×™×ª×Ÿ ×œ×˜×¢×•×Ÿ ××ª ×”××¡××›×™× ×›×¨×’×¢. ×× × × ×¡×” ×©×•×‘ ×××•×—×¨ ×™×•×ª×¨.');
            }
        }

        // escape HTML ×œ××‘×˜×—×”
        function escapeHtml(text) {
            if (!text) return '';
            const div = document.createElement('div');
            div.textContent = String(text);
            return div.innerHTML;
        }

        // ×”×¦×’×ª ××¡××›×™×
        function displayDocuments() {
            const container = document.getElementById('documents-grid');
            container.innerHTML = '';

            documents.forEach((doc, index) => {
                const docCard = document.createElement('div');
                docCard.className = 'document-card';
                docCard.style.animationDelay = `${0.1 + index * 0.05}s`;

                docCard.innerHTML = `
                    <span class="pdf-badge">PDF</span>
                    <span class="document-emoji">${doc.emoji || 'ğŸš¨'}</span>
                    <div class="document-title">${escapeHtml(doc.title)}</div>
                `;

                docCard.onclick = function() {
                    openDocument(doc.url);
                };

                container.appendChild(docCard);
            });

            // ×”×¡×ª×¨×ª ××¡×š ×˜×¢×™× ×” ×•×”×¦×’×ª ×¨×©×ª
            document.getElementById('loading-screen').style.display = 'none';
            document.getElementById('documents-grid').style.display = 'grid';

            console.log(`âœ… ${documents.length} ××¡××›×™× ××•×¦×’×™× ×‘×××©×§`);
        }

        // ×”×¦×’×ª ×©×’×™××”
        function showError(message) {
            document.getElementById('loading-screen').style.display = 'none';
            document.getElementById('error-screen').style.display = 'block';
            document.getElementById('error-text').textContent = message;
        }

        // ×¤×ª×™×—×ª ××¡××š
        function openDocument(url) {
            // ×•×œ×™×“×¦×™×” × ×•×¡×¤×ª ×œ×¤× ×™ ×¤×ª×™×—×”
            if (!isValidUrl(url)) {
                console.error('URL ×œ× ×ª×§×™×Ÿ');
                alert('×§×™×©×•×¨ ×œ× ×ª×§×™×Ÿ');
                return;
            }

            // ×¤×ª×™×—×” ×¢× ××‘×˜×—×”
            const newWindow = window.open(url, '_blank', 'noopener,noreferrer');
            if (newWindow) {
                newWindow.opener = null; // ×× ×™×¢×ª ×’×™×©×” ×œ×—×œ×•×Ÿ ×”××§×•×¨×™
            }
        }

        // ×—×–×¨×”
        function goBack() {
            // ×‘×“×™×§×” ×©×™×© ×”×™×¡×˜×•×¨×™×”
            if (window.history.length > 1) {
                window.history.back();
            } else {
                goHome();
            }
        }

        // ×—×–×¨×” ×œ×‘×™×ª
        function goHome() {
            // ×× ×™×¢×ª open redirect
            window.location.href = './index.html';
        }

        // ×× ×™×¢×ª ×–×•× ×›×¤×•×œ
        let lastTouchEnd = 0;
        document.addEventListener('touchend', function(e) {
            const now = Date.now();
            if (now - lastTouchEnd <= 300) {
                e.preventDefault();
            }
            lastTouchEnd = now;
        }, false);

        // ×˜×¢×™× ×” ×‘×¢×ª ×”×¢×œ××ª ×”×“×£
        window.addEventListener('load', loadDocuments);
    </script>
</body>
</html>
